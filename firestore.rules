rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /*****************************************************************
     * USERS
     *
     * Rules for the `/users` collection.
     *****************************************************************/
    match /users/{userId} {
      /**
       * @description A user can create their own profile document.
       * The document ID must match their UID and the email must match.
       * @allow (create) Authenticated users can create their own profile.
       */
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.email == request.auth.token.email;

      /**
       * @description A user can read their own profile.
       * @allow (get) Authenticated users can read their own profile.
       */
      allow get: if request.auth != null && request.auth.uid == userId;

      /**
       * @description User profiles are private and cannot be listed,
       * updated, or deleted from the client-side after creation.
       * @allow (list) Disabled for clients.
       * @allow (update) Disabled for clients.
       * @allow (delete) Disabled for clients.
       */
      allow list, update, delete: if false;
    }

    /*****************************************************************
     * PROVIDERS
     *
     * Rules for the `/providers` collection. Provider profiles are
     * public, but can only be created by authenticated users.
     *****************************************************************/
    match /providers/{providerId} {
      /**
       * @description Provider profiles are public.
       * @allow (get) Anyone can view a provider's profile.
       * @allow (list) Anyone can list/query providers for search.
       */
      allow get, list: if true;

      /**
       * @description Authenticated users can submit a provider profile.
       * The submitted data must conform to the schema and include the
       * user's UID.
       */
       allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 1
                    && request.resource.data.category is string
                    && request.resource.data.category.size() > 0
                    && request.resource.data.location is string
                    && request.resource.data.location.size() > 1;

      /**
       * @description Client-side updates/deletes are disabled to protect data integrity.
       * @allow (update) Disabled for clients.
       * @allow (delete) Disabled for clients.
       */
      allow update, delete: if false;
    }
  }
}
